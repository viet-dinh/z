import{r as s,j as e}from"./react-e6ac2c17.js";import"./app-3d800463.js";import{c as Y}from"./react-dom-78517e0e.js";import{c as q,r as J,I as N,P as Z,C as T,a as ee,T as te,b as se,d as ne,e as $,M as P,f as _,g as L,B as w,D as O,h as B,i as F,j as M,k,l as X,m as re,n as oe}from"./@mui-5b3946fa.js";import{F as ae,f as ie}from"./@fortawesome-48112f05.js";import{a as le}from"./axios-4a70c6fc.js";import{f as z,v as U}from"./date-fns-3ef0deee.js";import{$ as ce}from"./@emoji-mart-8aaaac64.js";import"./@babel-3068e525.js";import"./alpinejs-a89a43e5.js";import"./scheduler-765c72db.js";import"./react-is-a192e302.js";import"./@emotion-96fae0bf.js";import"./hoist-non-react-statics-3f8ebaa8.js";import"./stylis-79144faa.js";import"./@popperjs-f3391c26.js";import"./clsx-1229b3e0.js";import"./react-transition-group-2501875d.js";import"./prop-types-999b5ce8.js";import"./emoji-mart-b1edb54e.js";const de=q({palette:{primary:{main:"#556cd6"},secondary:{main:"#19857b"},error:{main:J.A400}}}),W=s.createContext(),me=({children:t,authUserId:n})=>{const[o]=s.useState(n);return e.jsx(W.Provider,{value:{authId:o},children:t})},he=()=>s.useContext(W),H=s.createContext(),ue=({children:t,data:n})=>{const[o]=s.useState(n);return e.jsx(H.Provider,{value:o,children:t})},xe=()=>s.useContext(H),y=le.create({baseURL:"/api/v1"});y.interceptors.response.use(function(t){return t},function(t){if(t.response&&t.response.status===401){const n=window.location.pathname+window.location.search;window.location.href=`/login?redirect=${encodeURIComponent(n)}`}return Promise.reject(t)});const pe="/build/assets/like-b3bdea1f.svg",je="/build/assets/love-c73ec6bb.svg",fe="/build/assets/laugh-75db9377.svg",ge="/build/assets/wow-8bf09024.svg",be="/build/assets/sad-cec3a1de.svg",Ce="/build/assets/angry-706e1179.svg",ye="/build/assets/add-reaction-ecbe65f9.svg",R={0:pe,1:je,2:fe,3:ge,4:be,5:Ce},S={LIKE:0,LOVE:1,LAUGH:2,WOW:3,SAD:4,ANGRY:5},K=({reactableType:t,reactableId:n,initialReactions:o})=>{const{authId:d}=he(),[i,u]=s.useState(o??[]),[l,x]=s.useState(null),j=Object.keys(S).reduce((r,c)=>{const h=S[c];let a=0,p=!1;return i.forEach(v=>{v.type===h&&(a++,v.user_id==d&&(p=!0))}),r[h]={type:h,count:a,active:p},r},{}),f=async({type:r,reaction:c})=>{try{await y.post(`/reactions/${t}/${n}`,{type:r}).then(h=>{h.data===0?c&&u(a=>a.filter(p=>p.id!==c.id)):u(a=>[...a,h.data])})}catch(h){console.error("Error updating reaction:",h)}x(null)},g=r=>{x(l?null:r.currentTarget)},m=()=>{x(null)},b=!!l,C=b?"reaction-popper":void 0;return e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[Object.values(j).map(({type:r,active:c,count:h})=>e.jsxs("button",{onClick:()=>f({type:r,reaction:i.filter(a=>a.user_id==d&&a.type===r).pop()}),title:r,className:`flex reaction-button items-center space-x-2 rounded-lg border ${h===0?"hidden":"inline-flex"} ${c?"highlight":""} hover:bg-gray-200 transition-all duration-200 ease-in-out cursor-pointer`,children:[e.jsx("img",{src:R[r],width:18,height:18,alt:r,className:"object-contain"}),e.jsx("span",{className:"text-sm ml-1 font-medium",children:h})]},r)),e.jsx(N,{onClick:g,children:e.jsx("img",{src:ye,width:18,height:18,alt:"Thêm reaction"})}),e.jsx(Z,{id:C,open:b,anchorEl:l,placement:"bottom-start",children:e.jsx(T,{onClickAway:m,children:e.jsx(ee,{className:"p-2 flex flex-wrap gap-4",children:Object.keys(S).map(r=>{const c=S[r];return e.jsx("div",{onClick:()=>f({type:c,reaction:i.filter(h=>h.user_id==d&&h.type===c).pop()}),className:"reaction-icon",children:e.jsx("img",{src:R[c],alt:r,className:"reaction-img"})},c)})})})})]})},G=({value:t,onChange:n,onSubmit:o,placeholder:d})=>{const[i,u]=s.useState(""),[l,x]=s.useState(!1),j=()=>{!(t!=null&&t.trim())||t.trim().length<2?u("Nhập ít nhất 2 ký tự"):(u(!1),o())},f=m=>{n({target:{value:t+m.native}})},g=()=>{x(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(te,{sx:{"& .MuiOutlinedInput-root":{"& fieldset":{borderColor:i?"red":"gray"},"&:hover fieldset":{borderColor:i?"red":"black"},"&.Mui-focused fieldset":{borderColor:i?"red":"black"}}},value:t,onChange:m=>{u(!1),n(m)},onKeyDown:m=>{if(m.key==="Enter"){if(m.shiftKey)return;m.preventDefault(),j()}},multiline:!0,rows:3,variant:"outlined",placeholder:d,fullWidth:!0,inputProps:{maxLength:1024},InputProps:{endAdornment:e.jsxs(se,{position:"end",children:[e.jsx(N,{onClick:()=>x(!l),title:"Thêm icons",children:e.jsx(ae,{style:{color:"#667085"},icon:ie})}),e.jsx(N,{onClick:j,children:e.jsx(ne,{})})]})},error:!!i,helperText:i}),l&&e.jsx(T,{onClickAway:g,children:e.jsxs("div",{style:{position:"absolute",zIndex:1},children:[e.jsx(ce,{onEmojiSelect:f})," "]})})]})},Q=({commentId:t,replyTo:n,addNewReply:o})=>{const[d,i]=s.useState("");s.useEffect(()=>{i(n)},[n]);const u=()=>{y.post(`/comments/${t}/replies`,{content:d}).then(({data:l})=>{o(l.data)}).catch(l=>console.error("Error submitting comment:",l))};return e.jsx("div",{className:"ml-4 mt-3",children:e.jsx("form",{className:"mt-3",onSubmit:l=>{l.preventDefault(),u()},children:e.jsx("div",{className:"form-group",children:e.jsx(G,{value:d,onChange:l=>i(l.target.value),onSubmit:()=>u()})})})})},I=s.createContext(),A=({children:t})=>{const[n,o]=s.useState([]);return e.jsx(I.Provider,{value:{replies:n,setReplies:o},children:t})},ve=({reply:t,onDelete:n})=>{var r;const{replies:o,setReplies:d}=s.useContext(I),[i,u]=s.useState(!1),[l,x]=s.useState(!1),[j,f]=s.useState(null),g=z(new Date(t.updated_at),{addSuffix:!0,locale:U}),m=async()=>{try{await y.delete(`/replies/${t.id}`).then(()=>d(o.filter(c=>c.id!=t.id)))}catch(c){console.error("Error deleting reply:",c)}finally{x(!1)}},b=c=>{f(c.currentTarget)},C=()=>{f(null)};return e.jsxs("div",{className:"bg-gray-100 shadow-sm rounded-lg p-4 mb-2",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("span",{className:"text-sm",children:[e.jsx("strong",{className:"font-semibold",children:t.user.name})," ",e.jsxs("span",{className:"text-secondary",children:[" - ",g]})]}),t.canDelete&&e.jsxs("div",{children:[e.jsxs(N,{onClick:b,size:"small",children:[e.jsx($,{fontSize:"small"})," "]}),e.jsx(P,{anchorEl:j,open:!!j,onClose:C,children:e.jsxs(_,{onClick:()=>x(!0),children:[e.jsx(L,{fontSize:"small",className:"mr-2"}),"Xóa"]})})]})]}),e.jsx("p",{className:"text-gray-700",style:{whiteSpace:"pre-line"},children:t.content}),e.jsxs("div",{className:"flex gap-2 mt-2 reply-container",children:[e.jsx(K,{reactableType:"reply",reactableId:t.id,initialReactions:t.reactions}),e.jsx("div",{children:e.jsx(w,{sx:{textTransform:"none"},variant:"text",className:"text-sm text-secondary normal-case",onClick:()=>u(!i),children:"Trả lời"})})]}),i&&e.jsx(Q,{replyTo:`@${(r=t.user)==null?void 0:r.name} `,commentId:t.comment_id,addNewReply:c=>{d(h=>[...h,c]),u(!1)}}),e.jsxs(O,{open:l,onClose:()=>x(!1),"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[e.jsx(B,{id:"alert-dialog-title",children:"Xác nhận xóa trả lời này"}),e.jsx(F,{children:e.jsxs(M,{id:"alert-dialog-description",children:["Trả lời",e.jsx(k,{variant:"p",className:"mt-2 bg-yellow-200 p-2 rounded shadow-lg",children:t.content.length<=32?t.content:t.content.slice(0,32)+"..."}),"sẽ bị xóa"]})}),e.jsxs(X,{children:[e.jsx(w,{onClick:()=>x(!1),color:"primary",children:"Hủy"}),e.jsx(w,{onClick:m,color:"error",autoFocus:!0,children:"Xóa"})]})]})]})},we=({commentId:t})=>{const{replies:n}=s.useContext(I),[o,d]=s.useState(!1);return s.useEffect(()=>{n.length&&d(!0)},[n]),e.jsxs("div",{className:"ml-4 mt-3",children:[n.length>0&&e.jsx("button",{onClick:()=>d(!o),className:"text-blue-500 hover:underline text-sm mb-2 text-secondary",children:o?`Ẩn trả lời (${n.length})`:`Xem trả lời (${n.length})`}),o&&n.map(i=>e.jsx(ve,{reply:i},i.id))]})},Ne=({value:t})=>{const[n,o]=s.useState(!1),d=(t==null?void 0:t.length)>128,i=()=>{o(!n)};return e.jsx("div",{className:"bg-white p-4 rounded-lg mb-4",children:e.jsxs(k,{className:"text-gray-700 inline",style:{whiteSpace:"pre-line",overflowWrap:"break-word",wordBreak:"break-word"},children:[n?t:`${t.slice(0,128)}`,d&&e.jsx(k,{variant:"body2",component:"span",onClick:i,className:"text-blue-500 underline cursor-pointer inline ml-2 text-secondary",children:n?"Thu lại":"Xem thêm"})]})})},D=({comment:t,onDelete:n})=>{var C;const{setReplies:o}=s.useContext(I),[d,i]=s.useState(!1),[u,l]=s.useState(!1),[x,j]=s.useState(null);s.useEffect(()=>{o((t==null?void 0:t.replies)??[])},[]);const f=z(new Date(t.updated_at),{addSuffix:!0,locale:U}),g=async()=>{try{await y.delete(`/comments/${t.id}`).then(r=>n(t.id))}catch(r){console.error("Error deleting comment:",r)}finally{l(!1)}},m=r=>{j(r.currentTarget)},b=()=>{j(null)};return e.jsxs("div",{className:"bg-white shadow-md rounded-lg p-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("span",{className:"text-sm",children:[e.jsx("strong",{className:"font-semibold",children:t.user.name}),t.chapter_order&&e.jsxs("span",{className:"text-secondary",children:[" - Chương ",t.chapter_order]}),e.jsxs("span",{className:"text-secondary",children:[" - ",f]})]}),t.canDelete&&e.jsxs("div",{children:[e.jsxs(N,{onClick:m,size:"small",children:[e.jsx($,{fontSize:"small"})," "]}),e.jsx(P,{anchorEl:x,open:!!x,onClose:b,children:e.jsxs(_,{onClick:()=>l(!0),children:[e.jsx(L,{fontSize:"small",className:"mr-2"}),"Xóa"]})})]})]}),e.jsx(Ne,{value:t.content}),e.jsxs("div",{className:"flex gap-2 mt-2 reply-container",children:[e.jsx(K,{reactableType:"comment",reactableId:t.id,initialReactions:t.reactions}),e.jsx("div",{children:e.jsx(w,{sx:{textTransform:"none"},variant:"text",className:"text-sm text-secondary normal-case",onClick:()=>i(!d),children:"Trả lời"})})]}),d&&e.jsx(Q,{replyTo:`@${(C=t.user)==null?void 0:C.name} `,commentId:t.id,addNewReply:r=>{o(c=>[...c,r]),i(!1)}}),e.jsx(we,{commentId:t.id}),e.jsxs(O,{open:u,onClose:()=>l(!1),"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[e.jsx(B,{id:"alert-dialog-title",children:"Xác nhận xóa bình luận này"}),e.jsx(F,{children:e.jsxs(M,{id:"alert-dialog-description",children:["Bình luận",e.jsx(k,{variant:"p",className:"mt-2 bg-yellow-200 p-2 rounded shadow-lg",children:t.content.length<=32?t.content:t.content.slice(0,32)+"..."}),"và tất cả trả lời của nó sẽ được ẩn đi"]})}),e.jsxs(X,{children:[e.jsx(w,{onClick:()=>l(!1),color:"primary",children:"Hủy"}),e.jsx(w,{onClick:g,color:"error",autoFocus:!0,children:"Xóa"})]})]})]})},Se=()=>{const{storyId:t,chapterOrder:n}=xe(),[o,d]=s.useState([]),[i,u]=s.useState(""),[l,x]=s.useState(1),[j,f]=s.useState(!0),[g,m]=s.useState(!1),b=s.useRef();s.useEffect(()=>{C(l)},[l]);const C=a=>{m(!0),y.get(`/stories/${t}/comments?page=${a}`).then(p=>{const v=p.data.data;d(V=>[...V,...v]),f(p.data.meta.current_page<p.data.meta.last_page),m(!1)}).catch(p=>{console.error("Error fetching comments:",p),m(!1)})},r=()=>{y.post(`/stories/${t}/comments`,{content:i,chapter_order:n??void 0}).then(a=>{d([a.data.data,...o]),u("")}).catch(a=>console.error("Error submitting comment:",a))},c=a=>{d(o.filter(p=>p.id!==a))},h=s.useCallback(a=>{b.current&&b.current.disconnect(),b.current=new IntersectionObserver(p=>{p[0].isIntersecting&&j&&!g&&x(v=>v+1)}),a&&b.current.observe(a)},[j,g]);return e.jsxs("div",{className:"mt-4",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Bình luận"}),e.jsx("form",{className:"space-y-4",children:e.jsx("div",{className:"form-group",children:e.jsx(G,{value:i,onChange:a=>u(a.target.value),onSubmit:()=>r(),placeholder:"Viêt bình luận"})})}),e.jsx("div",{className:"mt-5 space-y-4",children:o.map((a,p)=>o.length===p+1?e.jsx("div",{ref:h,children:e.jsx(A,{children:e.jsx(D,{comment:a,onDelete:c})})},a.id):e.jsx(A,{children:e.jsx(D,{comment:a,onDelete:c})},a.id))}),g&&e.jsxs("div",{className:"text-center mt-4",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-blue-500 border-solid"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"Loading..."})]})]})};function ke(){return e.jsx("div",{children:e.jsx(Se,{})})}const E=document.getElementById("root"),Ie=E.getAttribute("story-id"),Ee=E.getAttribute("chapter-order"),Re=E.getAttribute("auth-user-id");Y.createRoot(E).render(e.jsxs(re,{theme:de,children:[e.jsx(oe,{}),e.jsx(me,{authUserId:Re,children:e.jsx(ue,{data:{storyId:Ie,chapterOrder:Ee},children:e.jsx(ke,{})})})]}));
